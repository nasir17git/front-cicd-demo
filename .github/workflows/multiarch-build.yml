name: ðŸš€ Multi-Arch Build Test

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  PKG: java-test

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [linux/amd64, linux/arm64]
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Prepare simple Java project
        run: |
          mkdir -p src/main/java/com/example
          cat > src/main/java/com/example/App.java <<'EOF'
          package com.example;
          public class App {
              public static void main(String[] args) {
                  System.out.println("Hello Multi-Arch!");
              }
          }
          EOF

          cat > build.gradle <<'EOF'
          plugins { id 'java' }
          group = 'com.example'
          version = '1.0.0'
          repositories { mavenCentral() }
          jar {
              manifest {
                  attributes 'Main-Class': 'com.example.App'
              }
          }
          EOF

          echo "rootProject.name = 'java-test'" > settings.gradle

      - name: â˜• Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: ðŸ”¨ Build with Gradle
        run: |
          gradle init || true   # gradlew ì—†ìœ¼ë‹ˆ ê¸°ë³¸ gradle ì„¤ì¹˜ ì‚¬ìš©
          gradle build

      - name: ðŸ”‘ Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build & Push ${{ matrix.arch }}
        run: |
          IMAGE_TAG=$(echo "${GITHUB_REF_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')
          echo "Building for ${{ matrix.arch }} â†’ $REGISTRY/$PKG:${IMAGE_TAG}-${{ matrix.arch##*/}}"

          cat > Dockerfile <<'EOF'
          FROM eclipse-temurin:17-jre-alpine
          WORKDIR /app
          COPY build/libs/*.jar app.jar
          ENTRYPOINT ["java","-jar","app.jar"]
          EOF

          docker buildx build \
            --platform ${{ matrix.arch }} \
            -t $REGISTRY/$PKG:${IMAGE_TAG}-${{ matrix.arch##*/}} \
            --push .

  manifest:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ”‘ Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ·ï¸ Create & Push Manifest
        run: |
          IMAGE_TAG=$(echo "${GITHUB_REF_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')
          docker buildx imagetools create \
            -t $REGISTRY/$PKG:$IMAGE_TAG \
            $REGISTRY/$PKG:${IMAGE_TAG}-amd64 \
            $REGISTRY/$PKG:${IMAGE_TAG}-arm64
