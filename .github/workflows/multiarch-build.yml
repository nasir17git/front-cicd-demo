name: üöÄ Docker Build & Push to GHCR

on:
  push:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  PKG: sse-server
  KEEP: 3

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: arm64
            platform: linux/arm64
    permissions:
      contents: read
      packages: write

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîë Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚öôÔ∏è Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ‚öôÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build & Push ${{ matrix.platform }}
        run: |
          IMAGE_NAME=$(echo "${GITHUB_REPOSITORY##*/}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')
          IMAGE_TAG=$(echo "${GITHUB_REF_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')

          echo "üì¶ ÎπåÎìú & Ìë∏Ïãú: $REGISTRY/$IMAGE_NAME:${IMAGE_TAG}-${{ matrix.arch }}"

          docker buildx build \
            --platform ${{ matrix.platform }} \
            -t $REGISTRY/$IMAGE_NAME:${IMAGE_TAG}-${{ matrix.arch }} \
            --push .

  manifest:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: üîë Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚öôÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üè∑Ô∏è Create & Push Manifest
        run: |
          IMAGE_NAME=$(echo "${GITHUB_REPOSITORY##*/}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')
          IMAGE_TAG=$(echo "${GITHUB_REF_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')

          echo "üì¶ Î©ÄÌã∞ÏïÑÌÇ§ manifest: $REGISTRY/$IMAGE_NAME:$IMAGE_TAG"

          docker buildx imagetools create \
            -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG \
            $REGISTRY/$IMAGE_NAME:${IMAGE_TAG}-amd64 \
            $REGISTRY/$IMAGE_NAME:${IMAGE_TAG}-arm64

      - name: üßπ Keep only latest image per branch tag
        run: |
          TAG=$(echo "${GITHUB_REF_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')
          echo "Cleaning up old images for tag: $TAG"

          gh api "orgs/${{ github.repository_owner }}/packages/container/$PKG/versions" \
            --jq '. | sort_by(.updated_at) | reverse | .[] | select(.metadata.container.tags[] == "'"$TAG"'") | .id' |
            tail -n +2 | while read -r vid; do
              echo "Deleting old version: $vid"
              gh api --method DELETE "orgs/${{ github.repository_owner }}/packages/container/$PKG/versions/$vid"
            done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üßπ Keep only last N versions overall
        run: |
          echo "Cleaning up, keeping only $KEEP most recent versions overall"

          gh api "orgs/${{ github.repository_owner }}/packages/container/$PKG/versions" \
            --jq '. | sort_by(.updated_at) | reverse | .[].id' |
            tail -n +$((KEEP+1)) | while read -r vid; do
              echo "Deleting old version: $vid"
              gh api --method DELETE "orgs/${{ github.repository_owner }}/packages/container/$PKG/versions/$vid"
            done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
