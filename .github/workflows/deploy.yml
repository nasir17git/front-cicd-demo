name: deploy frontend

# ì‹¤í–‰ ì´ë¦„: PRì´ë²¤íŠ¸ë©´ PRë²ˆí˜¸/ì œëª© + SHA, ìˆ˜ë™ì´ë©´ ë¸Œëœì¹˜+ì…ë ¥SHA
run-name: |
  ${{ github.event_name == 'pull_request' &&
      format('Deploy PR #{0} "{1}" / {2}',
        github.event.pull_request.number,
        github.event.pull_request.title,
        github.event.pull_request.head.sha
      )
      || format('Deploy BR {0} / {1}',
        github.ref_name,
        github.event.inputs.commit || 'latest HEAD'
      )
  }}

on:
  workflow_dispatch:
    inputs:
      commit:
        description: "8ìë¦¬ short SHA (ë¹„ì›Œë‘ë©´ ë¸Œëœì¹˜ì˜ ìµœì‹  ì»¤ë°‹)"
        required: false
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # âœ… ê³µí†µ checkout: ì´ë²¤íŠ¸ë³„ë¡œ SHA ê²°ì •
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.ref }}

    # âœ… SHA ê³„ì‚° (PRì´ë©´ head.sha, ìˆ˜ë™ì´ë©´ ì…ë ¥ê°’ or HEAD)
    - name: Resolve commit SHA
      id: resolve_sha
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          FULL_SHA="${{ github.event.pull_request.head.sha }}"
        else
          if [ -n "${{ github.event.inputs.commit }}" ]; then
            FULL_SHA=$(git rev-parse ${{ github.event.inputs.commit }})
          else
            FULL_SHA=$(git rev-parse HEAD)
          fi
        fi
        SHORT_SHA=$(echo $FULL_SHA | cut -c1-8)
        echo "Using commit: $FULL_SHA ($SHORT_SHA)"
        echo "full_sha=$FULL_SHA" >> $GITHUB_OUTPUT
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    # âœ… ì»¤ë°‹ SHA ì¹˜í™˜
    - name: Replace commit SHA in Home.tsx
      run: |
        SHORT_SHA="${{ steps.resolve_sha.outputs.short_sha }}"
        sed -i "s/COMMIT_SHA/$SHORT_SHA/g" src/components/pages/Home.tsx

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    # âœ… ë°°í¬ìš© tar.gz ìƒì„±
    - name: Create deployment archive
      run: |
        if [ -d build ]; then
          tar -czf deploy.tar.gz -C build .
        else
          echo "âŒ No build output found!" && exit 1
        fi

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_GROOT_KEY }}

    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H deploy.logonme.click >> ~/.ssh/known_hosts || true

    - name: Deploy to server
      run: |
        scp deploy.tar.gz ec2-user@deploy.logonme.click:/home/ec2-user/
        ssh ec2-user@deploy.logonme.click "cd /home/ec2-user && ./deploy.sh"

    # âœ… ë°°í¬ í›„ ìŠ¬ë¡¯ í™•ì¸
    - name: Get active slot
      id: active_slot
      run: |
        SLOT=$(ssh ec2-user@deploy.logonme.click "(cat /home/ec2-user/DEPLOY_SLOT || echo 'green')")
        echo "slot=$SLOT" >> $GITHUB_OUTPUT

    # âœ… ë°°í¬ëœ URL ì •ìƒ ì‘ë‹µ í™•ì¸ (5ë¶„ ë™ì•ˆ 10ì´ˆ ê°„ê²© ì¬ì‹œë„)
    - name: Verify deployed URL
      run: |
        SLOT="${{ steps.active_slot.outputs.slot }}"
        URL="https://${SLOT}.logonme.click"

        echo "ğŸ” ë°°í¬ ê²€ì¦ ì‹œì‘: ${URL}"
        ATTEMPTS=30   # 30íšŒ * 10ì´ˆ = 5ë¶„
        COUNT=0

        while [ $COUNT -lt $ATTEMPTS ]; do
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${URL}" || echo "000")
          echo "Attempt $((COUNT+1)) â†’ HTTP $STATUS_CODE"

          if [ "$STATUS_CODE" = "200" ]; then
            echo "âœ… ê²€ì¦ ì„±ê³µ! HTTP 200"
            exit 0
          fi

          COUNT=$((COUNT+1))
          echo "â³ 10ì´ˆ í›„ ì¬ì‹œë„..."
          sleep 10
        done

        echo "âŒ ê²€ì¦ ì‹¤íŒ¨! 5ë¶„ ë™ì•ˆ HTTP 200 ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
        exit 1

    # âœ… Summary ì¶œë ¥ (PRì´ë²¤íŠ¸ì™€ ìˆ˜ë™ ë‘˜ ë‹¤ ì§€ì›)
    - name: Write deployment summary
      run: |
        SLOT="${{ steps.active_slot.outputs.slot }}"
        SHORT_SHA="${{ steps.resolve_sha.outputs.short_sha }}"
        URL="https://${SLOT}.logonme.click"

        echo "## ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| PR ë²ˆí˜¸ | #${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì œëª© | ${{ github.event.pull_request.title }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¸Œëœì¹˜ | ${{ github.head_ref }} |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ë¸Œëœì¹˜ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "| ì»¤ë°‹ SHA | \`${SHORT_SHA}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ë°°í¬ ìŠ¬ë¡¯ | \`${SLOT}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ì ‘ì† URL | [${URL}](${URL}) |" >> $GITHUB_STEP_SUMMARY

    # âœ… PR ì´ë²¤íŠ¸ë©´ ì½”ë©˜íŠ¸ ì‘ì„±
    - name: Comment on PR with deployed commit
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const slot = "${{ steps.active_slot.outputs.slot }}".trim();
          const shortSha = "${{ steps.resolve_sha.outputs.short_sha }}";
          const url = `https://${slot}.logonme.click`;
          const pr_number = Number("${{ github.event.pull_request.number }}");

          github.rest.issues.createComment({
            issue_number: pr_number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš€ PR **#${pr_number} (${context.payload.pull_request.head.ref})**\nì»¤ë°‹ \`${shortSha}\` ì´(ê°€) **${slot}** ìŠ¬ë¡¯ì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nğŸ‘‰ [${url}](${url})`
          });
